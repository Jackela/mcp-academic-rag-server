{% extends "base.html" %}

{% block title %}文献问答 - 学术文献RAG系统{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 250px);
        min-height: 500px;
        display: flex;
        flex-direction: column;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    .message-bubble {
        max-width: 80%;
        margin-bottom: 15px;
        border-radius: 18px;
        padding: 12px 15px;
        position: relative;
    }
    .user-message {
        background-color: #e3f2fd;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }
    .assistant-message {
        background-color: #f5f5f5;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }
    .message-time {
        font-size: 0.7rem;
        color: #888;
        text-align: right;
        margin-top: 5px;
    }
    .chat-input-container {
        padding: 15px;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        border-radius: 0 0 0.375rem 0.375rem;
    }
    .citation {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px 15px;
        margin-top: 10px;
        border-radius: 5px;
        font-size: 0.9rem;
    }
    .citation-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .typing-indicator {
        display: none;
        align-items: center;
        margin-bottom: 15px;
    }
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
        animation: typing 1s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    @keyframes typing {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-9 mx-auto">
        <div class="card shadow-sm chat-container">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">基于文献的学术问答</h5>
                <div>
                    <button id="clearChat" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-trash me-1"></i>清空对话
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message-bubble assistant-message">
                    <div>您好！我是学术文献RAG助手，我可以根据已处理的学术文献回答您的问题。请问您想了解什么？</div>
                    <div class="message-time">现在</div>
                </div>
                
                <!-- 消息历史将通过JavaScript动态加载 -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="message-bubble {% if message.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                            <div>{{ message.content }}</div>
                            <div class="message-time">{{ message.timestamp|fromtimestamp }}</div>
                            
                            {% if message.role == 'assistant' and message.message_id in citations %}
                                {% for citation in citations[message.message_id] %}
                                    <div class="citation">
                                        <div class="citation-title">引用来源：{{ citation.metadata.title|default('未知文档') }}</div>
                                        <div>{{ citation.text }}</div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
                
                <div class="typing-indicator assistant-message" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <div class="chat-input-container">
                <form id="chatForm" class="d-flex">
                    <input type="text" id="userInput" class="form-control me-2" placeholder="输入您的问题..." required>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
                <div class="form-text mt-2">提示：尝试询问有关已上传文献的具体问题，以获得更精确的回答</div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">功能说明</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold"><i class="bi bi-lightbulb me-2 text-warning"></i>如何提问</h6>
                        <ul class="ps-4">
                            <li>询问具体文献的内容、方法和结论</li>
                            <li>请求总结或比较多篇文献</li>
                            <li>提问特定学术概念或理论</li>
                            <li>多轮对话深入探讨相关问题</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold"><i class="bi bi-info-circle me-2 text-info"></i>关于引用来源</h6>
                        <ul class="ps-4">
                            <li>回答将自动显示相关文献引用</li>
                            <li>引用内容来自实际文献片段</li>
                            <li>可以通过文档管理查看完整文献</li>
                            <li>引用精度依赖于文档处理质量</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const chatMessages = document.getElementById('chatMessages');
        const typingIndicator = document.getElementById('typingIndicator');
        const clearChatButton = document.getElementById('clearChat');
        
        // 页面加载完成后滚动到最新消息
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // 提交表单处理
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const userMessage = userInput.value.trim();
            if (!userMessage) return;
            
            // 添加用户消息到聊天界面
            addMessageToChat('user', userMessage);
            
            // 清空输入框
            userInput.value = '';
            
            // 显示正在输入指示器
            typingIndicator.style.display = 'flex';
            
            // 发送API请求
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: userMessage })
            })
            .then(response => response.json())
            .then(data => {
                // 隐藏输入指示器
                typingIndicator.style.display = 'none';
                
                if (data.error) {
                    // 处理错误
                    addErrorMessage(data.error);
                } else {
                    // 添加助手回复
                    addMessageToChat('assistant', data.answer, data.citations);
                }
            })
            .catch(error => {
                // 隐藏输入指示器
                typingIndicator.style.display = 'none';
                // 处理错误
                addErrorMessage('请求处理失败，请稍后重试');
                console.error('Error:', error);
            });
        });
        
        // 清空聊天记录
        clearChatButton.addEventListener('click', function() {
            if (confirm('确定要清空当前对话吗？此操作不可撤销。')) {
                // 只保留欢迎消息
                chatMessages.innerHTML = `
                    <div class="message-bubble assistant-message">
                        <div>您好！我是学术文献RAG助手，我可以根据已处理的学术文献回答您的问题。请问您想了解什么？</div>
                        <div class="message-time">现在</div>
                    </div>
                    <div class="typing-indicator assistant-message" id="typingIndicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;
                
                // 更新引用指示器变量
                typingIndicator = document.getElementById('typingIndicator');
                
                // 重置会话
                fetch('/api/chat/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .catch(error => {
                    console.error('Error resetting chat:', error);
                });
            }
        });
        
        // 添加消息到聊天界面
        function addMessageToChat(role, content, citations = []) {
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${role === 'user' ? 'user-message' : 'assistant-message'}`;
            
            // 消息内容
            const contentElement = document.createElement('div');
            contentElement.textContent = content;
            messageElement.appendChild(contentElement);
            
            // 时间戳
            const timeElement = document.createElement('div');
            timeElement.className = 'message-time';
            timeElement.textContent = '刚刚';
            messageElement.appendChild(timeElement);
            
            // 添加引用内容
            if (role === 'assistant' && citations && citations.length > 0) {
                citations.forEach(citation => {
                    const citationElement = document.createElement('div');
                    citationElement.className = 'citation';
                    
                    const titleElement = document.createElement('div');
                    titleElement.className = 'citation-title';
                    titleElement.textContent = `引用来源：${citation.metadata?.title || '未知文档'}`;
                    citationElement.appendChild(titleElement);
                    
                    const textElement = document.createElement('div');
                    textElement.textContent = citation.text;
                    citationElement.appendChild(textElement);
                    
                    messageElement.appendChild(citationElement);
                });
            }
            
            // 插入到聊天记录前面
            chatMessages.insertBefore(messageElement, typingIndicator);
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 添加错误消息
        function addErrorMessage(errorText) {
            const messageElement = document.createElement('div');
            messageElement.className = 'alert alert-danger mx-3 my-2';
            messageElement.textContent = `错误: ${errorText}`;
            
            // 插入到聊天记录前面
            chatMessages.insertBefore(messageElement, typingIndicator);
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}
